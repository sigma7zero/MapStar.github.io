<!doctype html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

        <title>Map Star</title>

        <!-- Babylon.js -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.6.2/dat.gui.min.js"></script>
        <script src="https://assets.babylonjs.com/generated/Assets.js"></script>
        <script src="https://cdn.babylonjs.com/recast.js"></script>
        <script src="https://cdn.babylonjs.com/ammo.js"></script>
        <script src="https://cdn.babylonjs.com/havok/HavokPhysics_umd.js"></script>
        <script src="https://cdn.babylonjs.com/cannon.js"></script>
        <script src="https://cdn.babylonjs.com/Oimo.js"></script>
        <script src="https://cdn.babylonjs.com/earcut.min.js"></script>
        <script src="https://cdn.babylonjs.com/babylon.js"></script>
        <script src="https://cdn.babylonjs.com/materialsLibrary/babylonjs.materials.min.js"></script>
        <script src="https://cdn.babylonjs.com/proceduralTexturesLibrary/babylonjs.proceduralTextures.min.js"></script>
        <script src="https://cdn.babylonjs.com/postProcessesLibrary/babylonjs.postProcess.min.js"></script>
        <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.js"></script>
        <script src="https://cdn.babylonjs.com/serializers/babylonjs.serializers.min.js"></script>
        <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
        <script src="https://cdn.babylonjs.com/addons/babylonjs.addons.min.js"></script>
        <script src="https://cdn.babylonjs.com/inspector/babylon.inspector.bundle.js"></script>

        <style>
            html,
            body {
                overflow: hidden;
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
            }

            #renderCanvas {
                width: 100%;
                height: 100%;
                touch-action: none;
            }

            #canvasZone {
                width: 100%;
                height: 100%;
            }
        </style>
    </head>
    <body>
        <div id="canvasZone"><canvas id="renderCanvas"></canvas></div>
        <script>
                    var canvas = document.getElementById("renderCanvas");

                    var startRenderLoop = function (engine, canvas) {
                        
                        engine.runRenderLoop(function () {
                            if (sceneToRender && sceneToRender.activeCamera) {
                                sceneToRender.render();
                                engineFPS = engine.getFps().toFixed();
                            }
                        });
                    }

            
    var engine = null;
    var scene = null;    
    var sceneToRender = null;
    var createDefaultEngine = function() { return new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true,  disableWebGL2Support: false}); };
    var createScene = async function () {    
    var scene = new BABYLON.Scene(engine);

    scene.clearColor = new BABYLON.Color3(0, 0, 0).toLinearSpace();
   
    // Sky sphere
    var skySphere = BABYLON.MeshBuilder.CreateSphere("sphere", { diameter: 1024, segments: 32 }, scene);
    skySphere.flipFaces(true);
    skySphere.position.x = 0;
    skySphere.position.y = 0;
    skySphere.position.z = 0;
    skySphere.rotate(BABYLON.Axis.X, BABYLON.Tools.ToRadians(180), BABYLON.Space.LOCAL);
    skySphere.receiveShadows = false;

    // Default sky material
    var skyMaterial = new BABYLON.StandardMaterial("skyMaterial", scene);
    skyMaterial.emissiveTexture = new BABYLON.Texture("https://dl.dropbox.com/s/7fs6edqfvfqvxua/Azure1.jpg", scene);
    skyMaterial.useEmissiveAsIllumination = true;
    skyMaterial.backFaceCulling = false;
    skySphere.material = skyMaterial;

    // Cameras  
    // 1  
    var gameCamera = new BABYLON.UniversalCamera("UniversalCamera", new BABYLON.Vector3(0, 2, -10), scene);
    gameCamera.setTarget(BABYLON.Vector3.Zero());
    gameCamera.attachControl(canvas, true);
    // 2
    var arcRotateCamera = new BABYLON.ArcRotateCamera("ArcRotateCamera", 0, 0, 10, new BABYLON.Vector3(0, 0, 0), scene);
    arcRotateCamera.setPosition(new BABYLON.Vector3(0, 2, -10));

    // Create a light source
    var light = new BABYLON.DirectionalLight("DirectLight1", new BABYLON.Vector3(1, -2, 1), scene);
    light.position = new BABYLON.Vector3(-20, 40, -20);

    // Default intensity is 1. Let's dim the light a small amount
    light.intensity = 0.6;
    light.diffuse = new BABYLON.Color3(0.83, 0.94, 1);

    // Our built-in 'sphere' shape.
    var sphere = BABYLON.MeshBuilder.CreateSphere("sphere", { diameter: 2, segments: 32 }, scene);

    // Move the sphere upward 1/2 its height
    sphere.position.y = 1;

    // Our built-in 'ground' shape.
    var ground = BABYLON.MeshBuilder.CreateGround("ground", { width: 6, height: 6 }, scene);

    // Shadows
    var shadowGenerator = new BABYLON.ShadowGenerator(1024, light);
    shadowGenerator.addShadowCaster(sphere);
    shadowGenerator.usePoissonSampling = true;
    ground.receiveShadows = true;    

    // LOADER
    engine.displayLoadingUI();

    // GUI
    let advancedTexture = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("GUI", true, scene);              
    let loadedGUI = await advancedTexture.parseFromURLAsync("https://raw.githubusercontent.com/sigma7zero/MapStar.github.io/main/guiTexture.json");
       
    // HELPERS      
    // Download the scene to the client's machine (Note: Web Safe)
    var objectUrl;

    function downloadSceneFile(filename, scene) {
        if(objectUrl) {
            window.URL.revokeObjectURL(objectUrl);
        }
    
        var serializedScene = BABYLON.SceneSerializer.Serialize(scene);
        
        var strMesh = JSON.stringify(serializedScene);
    
        if (filename.toLowerCase().lastIndexOf(".babylon") !== filename.length - 8 || filename.length < 9){
            filename += ".babylon";
        }
            
	    var blob = new Blob ( [ strMesh ], { type : "octet/stream" } );
       
        // turn blob into an object URL; saved as a member, so can be cleaned out later
        objectUrl = (window.webkitURL || window.URL).createObjectURL(blob);
    
        var link = window.document.createElement('a');
        link.href = objectUrl;
        link.download = filename;
        var click = document.createEvent("MouseEvents");
        click.initEvent("click", true, false);
        link.dispatchEvent(click);          
    }

    function serializedSceneToString(_scene){
        if (_scene == null) return 0;        
        var serializedScene = BABYLON.SceneSerializer.Serialize(scene);
	    var strScene = JSON.stringify(serializedScene);
        return strScene;
    }

    function saveTextAsFile(strToSave, fileNameToSaveAs){

        var textToWrite = strToSave;
        var textFileAsBlob = new Blob([textToWrite], {type:'text/plain'});    
        var downloadLink = document.createElement("a");
        downloadLink.download = fileNameToSaveAs;
        downloadLink.innerHTML = "Download File";
        if (window.webkitURL != null)
        {
            // Chrome allows the link to be clicked
            // without actually adding it to the DOM.
            downloadLink.href = window.webkitURL.createObjectURL(textFileAsBlob);
        }
        else
        {
            // Firefox requires the link to be added to the DOM
            // before it can be clicked.
            downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
            downloadLink.onclick = destroyClickedElement;
            downloadLink.style.display = "none";
            document.body.appendChild(downloadLink);
        }

        downloadLink.click();
    }

    //Stats etc
    var instrumentation = new BABYLON.SceneInstrumentation(scene);    
    var toggleStats = true;    
    if (toggleStats){
        instrumentation.captureFrameTime = true;
        instrumentation.captureActiveMeshesEvaluationTime = true;
        instrumentation.captureRenderTargetsRenderTime = true;
        instrumentation.captureFrameTime = true;
        instrumentation.captureRenderTime = true;
        instrumentation.captureInterFrameTime = true;
        instrumentation.captureParticlesRenderTime = true;
        instrumentation.captureSpritesRenderTime = true;
        instrumentation.capturePhysicsTime = true;
        instrumentation.captureAnimationsTime = true;
    }

    //const urlText = 'https://corsproxy.io/?https://raw.githubusercontent.com/sigma7zero/MapStar/main/fileManifest.txt';
    //const urlText = 'https://corsproxy.io/?' + encodeURIComponent('https://raw.githubusercontent.com/sigma7zero/MapStar/main/fileManifest.txt');
    //const urlText = 'https://raw.githubusercontent.com/sigma7zero/MapStar/main/fileManifest.txt';

    const proxy = "https://cors-anywhere.herokuapp.com/";
    const fileManifest  = "https://raw.githubusercontent.com/sigma7zero/MapStar/main/fileManifest.txt"; 
    const urlText = proxy + fileManifest;
	    
    function getText(url){
        //read text from url location 
        var request = new XMLHttpRequest();
        request.open('GET', url, false);
        request.send(null);
        return request.responseText;       
    }
    var fileList = getText(urlText);
    console.log("List of files in the repository server-side: \n\n" + fileList);

    //Populate Open File Dialog with file list
    let textFileList = advancedTexture.getControlByName("TextFileList");
    textFileList.text = fileList;

    // Resources 
    // Environment Map Library
    let environmentLibrary = advancedTexture.getControlByName("EnvironmentLibrary");
    var numberOfUrls = environmentLibrary.text.toString().split(" ").length;
    //console.log("Environment Library contains: " + numberOfUrls.toString() + " Urls");

    let addURLToLibraryButton = advancedTexture.getControlByName("addURLToLibraryButton");
    let addURLButtonLight = advancedTexture.getControlByName("addURLButtonLight");
    addURLToLibraryButton.onPointerUpObservable.add(function () {        
        addURLButtonLight.isVisible = false;
     });
    addURLToLibraryButton.onPointerEnterObservable.add(function () { addURLButtonLight.isVisible = true });
    addURLToLibraryButton.onPointerOutObservable.add(function () { addURLButtonLight.isVisible = false });

    let deleteURLFromLibraryButton = advancedTexture.getControlByName("deleteURLFromLibraryButton");
    let deleteURLButtonLight = advancedTexture.getControlByName("deleteURLButtonLight");
    deleteURLFromLibraryButton.onPointerUpObservable.add(function () {         
        deleteURLButtonLight.isVisible = false;
     });
    deleteURLFromLibraryButton.onPointerEnterObservable.add(function () { deleteURLButtonLight.isVisible = true });
    deleteURLFromLibraryButton.onPointerOutObservable.add(function () { deleteURLButtonLight.isVisible = false });
    
    let newProjectWindow = advancedTexture.getControlByName("NewWindow");    
    newProjectWindow.isVisible = false;
        
    let saveProjectWindow = advancedTexture.getControlByName("SaveWindow");
    saveProjectWindow.isVisible = false;

    let openProjectWindow = advancedTexture.getControlByName("OpenWindow");    
    openProjectWindow.isVisible = false;
        
    //Asset tabs manager
    let tab_MapsButton = advancedTexture.getControlByName("tab_Maps");
    let tab_ModelsButton = advancedTexture.getControlByName("tab_Models");
    let tab_MaterialsButton = advancedTexture.getControlByName("tab_Materials");
    let tab_TexturesButton = advancedTexture.getControlByName("tab_Textures");
    let tab_SoundsButton = advancedTexture.getControlByName("tab_Sounds"); 
    let selectMarkerDotMaps = advancedTexture.getControlByName("selectMarkerDotMaps");
    let selectMarkerDotModels = advancedTexture.getControlByName("selectMarkerDotModels");
    let selectMarkerDotMaterials = advancedTexture.getControlByName("selectMarkerDotMaterials");
    let selectMarkerDotTextures = advancedTexture.getControlByName("selectMarkerDotTextures");
    let selectMarkerDotSounds = advancedTexture.getControlByName("selectMarkerDotSounds");
    let tab_selected = "Maps";
    console.log("START TAB: " + tab_selected);

    tab_MapsButton.onPointerUpObservable.add(function () {

        tab_selected = "Maps";
	selectMarkerDotMaps.isVisible = true;
        console.log("TAB SELECT: " + tab_selected);

    });

    tab_ModelsButton.onPointerUpObservable.add(function () {

        tab_selected = "Models";
	selectMarkerDotModels.isVisible = true;
        console.log("TAB SELECT: " + tab_selected);
    });

    tab_MaterialsButton.onPointerUpObservable.add(function () {

        tab_selected = "Materials";
	selectMarkerDotMaterials.isVisible = true;
        console.log("TAB SELECT: " + tab_selected);
    });

    tab_TexturesButton.onPointerUpObservable.add(function () {

        tab_selected = "Textures";
	selectMarkerDotTextures.isVisible = true;
        console.log("TAB SELECT: " + tab_selected);
    });

    tab_SoundsButton.onPointerUpObservable.add(function () {

        tab_selected = "Sounds";
	selectMarkerDotSounds.isVisible = true;
        console.log("TAB SELECT: " + tab_selected);
    });





    let newButton = advancedTexture.getControlByName("ButtonNew");
    newButton.onPointerUpObservable.add(function () { 
        if (!newProjectWindow.isVisible) {
            newProjectWindow.isVisible = true;
            advancedTexture.getControlByName("illuminateNewButton").isVisible = true
        }
        else {
            newProjectWindow.isVisible = false;
            advancedTexture.getControlByName("illuminateNewButton").isVisible = false
        }
        });

    newButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateNewButton").isVisible = true });
    newButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateNewButton").isVisible = false });
 
    let openButton = advancedTexture.getControlByName("ButtonOpen");
    openButton.onPointerUpObservable.add(function () { 
         if (!openProjectWindow.isVisible) {
            openProjectWindow.isVisible = true;
            advancedTexture.getControlByName("illuminateOpenButton").isVisible = true
        }
        else {
            openProjectWindow.isVisible = false;
            advancedTexture.getControlByName("illuminateOpenButton").isVisible = false
        }        
    });
        
    openButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateOpenButton").isVisible = true });
    openButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateOpenButton").isVisible = false });

    let saveButton = advancedTexture.getControlByName("ButtonSave");
    saveButton.onPointerUpObservable.add(function () { 
        if (!saveProjectWindow.isVisible) {
            saveProjectWindow.isVisible = true;
            advancedTexture.getControlByName("illuminateSaveButton").isVisible = true
        }
        else {
            saveProjectWindow.isVisible = false;
            advancedTexture.getControlByName("illuminateSaveButton").isVisible = false
        }                
    });
        
    saveButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateSaveButton").isVisible = true });
    saveButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateSaveButton").isVisible = false });

    let exportButton = advancedTexture.getControlByName("ButtonExport");
    exportButton.onPointerUpObservable.add(function () { alert("ButtonExport Pressed!...."); });
    exportButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateExportButton").isVisible = true });
    exportButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateExportButton").isVisible = false });

    let envButton = advancedTexture.getControlByName("envButton");
    let envButtonLight = advancedTexture.getControlByName("envButtonLight");
    
    let envWindow = advancedTexture.getControlByName("envWindow");        
    envWindow.isVisible = false;
        
    envButtonLight.isVisible = envWindow.isVisible;
    envButton.onPointerUpObservable.add(function () {
        if (!envWindow.isVisible) {
            envWindow.isVisible = true;
            envButtonLight.isVisible = true;
        }
        else {
            envWindow.isVisible = false;
            envButtonLight.isVisible = false;
        }
    });

    envButton.onPointerEnterObservable.add(function () {
        if (!envWindow.isVisible) {
            envButtonLight.isVisible = true;
        }
    });

    envButton.onPointerOutObservable.add(function () {
        if (!envWindow.isVisible) {
            envButtonLight.isVisible = false;
        }
    });
    
    let cameraEnvButton = advancedTexture.getControlByName("cameraEnvButton");
    let cameraEnvButtonLight = advancedTexture.getControlByName("cameraEnvButtonLight");
    
    cameraEnvButton.onPointerUpObservable.add(function () { alert("ButtonTerrain Pressed!...."); });
    
    cameraEnvButton.onPointerEnterObservable.add(function () {       
            cameraEnvButtonLight.isVisible = true;        
    });

    cameraEnvButton.onPointerOutObservable.add(function () {       
            cameraEnvButtonLight.isVisible = false;        
    });

    let lightingEnvButton = advancedTexture.getControlByName("lightingEnvButton");
    let lightingEnvButtonLight = advancedTexture.getControlByName("lightingEnvButtonLight");
    
    lightingEnvButton.onPointerUpObservable.add(function () { alert("ButtonTerrain Pressed!...."); });
    
    lightingEnvButton.onPointerEnterObservable.add(function () {       
            lightingEnvButtonLight.isVisible = true;        
    });

    lightingEnvButton.onPointerOutObservable.add(function () {       
            lightingEnvButtonLight.isVisible = false;        
    });

    let libraryEnvButton = advancedTexture.getControlByName("libraryEnvButton");
    let libraryButtonLight = advancedTexture.getControlByName("libraryButtonLight");
    let libraryEnvWindow = advancedTexture.getControlByName("libraryEnvWindow");

    libraryEnvWindow.isVisible = false;
    libraryButtonLight.isVisible = libraryEnvWindow.isVisible;
    libraryEnvButton.onPointerUpObservable.add(function () {
        if (!libraryEnvWindow.isVisible) {
            libraryEnvWindow.isVisible = true;
            libraryButtonLight.isVisible = true;
        }
        else {
            libraryEnvWindow.isVisible = false;
            libraryButtonLight.isVisible = false;
        }
    });

    libraryEnvButton.onPointerEnterObservable.add(function () {
        if (!libraryEnvWindow.isVisible) {
            libraryButtonLight.isVisible = true;
        }
    });

    libraryEnvButton.onPointerOutObservable.add(function () {
        if (!libraryEnvWindow.isVisible) {
            libraryButtonLight.isVisible = false;
        }
    });

    let cancelEnvButton = advancedTexture.getControlByName("cancelEnvButton");
    let cancelEnvButtonLight = advancedTexture.getControlByName("cancelEnvButtonLight");
    cancelEnvButton.onPointerUpObservable.add(function () {
        if (!envWindow.isVisible) {
            envWindow.isVisible = true;
            envButtonLight.isVisible = true;
        }
        else {
            envWindow.isVisible = false;
            envButtonLight.isVisible = false;
        }

        if (!libraryEnvWindow.isVisible) {
            libraryEnvWindow.isVisible = true;
            libraryButtonLight.isVisible = true;
        }
        else {
            libraryEnvWindow.isVisible = false;
            libraryButtonLight.isVisible = false;
        }
    });

    cancelEnvButton.onPointerEnterObservable.add(function () {       
            cancelEnvButtonLight.isVisible = true;        
    });

    cancelEnvButton.onPointerOutObservable.add(function () {       
            cancelEnvButtonLight.isVisible = false;       
    });


    let applyEnvButton = advancedTexture.getControlByName("applyEnvButton");
    let applyEnvButtonLight = advancedTexture.getControlByName("applyEnvButtonLight");

    applyEnvButton.onPointerUpObservable.add(function () {
       //Set this selection as the environment map background 
        if (!envWindow.isVisible) {
            envWindow.isVisible = true;
            envButtonLight.isVisible = true;
        }
        else {
            envWindow.isVisible = false;
            envButtonLight.isVisible = false;
        }
        
       if (!libraryEnvWindow.isVisible) {
            libraryEnvWindow.isVisible = true;
            libraryButtonLight.isVisible = true;
        }
        else {
            libraryEnvWindow.isVisible = false;
            libraryButtonLight.isVisible = false;
        }      
    });

    applyEnvButton.onPointerEnterObservable.add(function () {       
            applyEnvButtonLight.isVisible = true;        
    });

    applyEnvButton.onPointerOutObservable.add(function () {       
            applyEnvButtonLight.isVisible = false;       
    });

    let numberOfThumbNails = loadedGUI.getControlByName("ThumbnailStack").getDescendants(true).length;
       
    let camToggle = false;
    let sm_cameraButton = advancedTexture.getControlByName("sm_cameraButton");
    let sm_cameraButtonLight = advancedTexture.getControlByName("sm_cameraButtonLight");
    let sm_cameraButton_cameraImage = advancedTexture.getControlByName("ImageCamera");
    let sm_cameraButton_gamePadImage = advancedTexture.getControlByName("ImageGamePad");
    let textblockCamType = advancedTexture.getControlByName("TextblockCamType");
    textblockCamType.text = "First Person Camera";
    sm_cameraButtonLight.isVisible = false;

    sm_cameraButton.onPointerUpObservable.add(function () {         
        
        if (!camToggle) {
            camToggle = true;   
            sm_cameraButton_cameraImage.isVisible = true;
            sm_cameraButton_gamePadImage.isVisible = false;
            textblockCamType.text = "Arc Rotate Camera";

            scene.activeCamera.detachControl(canvas);
            scene.activeCamera = arcRotateCamera;
            scene.activeCamera.attachControl(canvas, true);

        }
        else {
            camToggle = false;
            sm_cameraButton_cameraImage.isVisible = false;
            sm_cameraButton_gamePadImage.isVisible = true;
            textblockCamType.text = "First Person Camera";
            scene.activeCamera.detachControl(canvas);
            scene.activeCamera = gameCamera;
            scene.activeCamera.attachControl(canvas, true);
        }       

    });

    sm_cameraButton.onPointerEnterObservable.add(function () {
        sm_cameraButtonLight.isVisible = true;
    });

    sm_cameraButton.onPointerOutObservable.add(function () {
        sm_cameraButtonLight.isVisible = false;
    });

    
    // Cross platform fullscreen toggle
    const canvasParent = document.getElementById("canvasZone");
    canvasParent.style.position = "relative";
    let fullScreenToggle = false;
    let smFullscreenButton = advancedTexture.getControlByName("smFullscreenButton");
    let smFullScreenButtonLight = advancedTexture.getControlByName("smFullScreenButtonLight");
    let smFullScreenButtonMaxIcon = advancedTexture.getControlByName("ImageMaxScreen");
    let smFullScreenButtonMinIcon = advancedTexture.getControlByName("ImageMinScreen");
        
    smFullScreenButtonLight.isVisible = false;
    smFullScreenButtonMaxIcon.isVisible = true;
    smFullScreenButtonMinIcon.isVisible = false; 
    
    let CreatePanelEndPoint = advancedTexture.getControlByName("CreatePanelEndPoint");


    smFullscreenButton.onPointerUpObservable.add(function () {
        
        if (!fullScreenToggle) {
            canvasParent.requestFullscreen();
            smFullScreenButtonMaxIcon.isVisible = false;
            smFullScreenButtonMinIcon.isVisible = true;
            fullScreenToggle = true;

            // Turn off slider in fullscreen mode
            CreatePanelEndPoint.isVisible = false;
        }
        else{
            document.exitFullscreen();
            smFullScreenButtonMaxIcon.isVisible = true;
            smFullScreenButtonMinIcon.isVisible = false;
            fullScreenToggle = false;

            // Turn on slider in window mode
            CreatePanelEndPoint.isVisible = true;
        }       
    });

    smFullscreenButton.onPointerEnterObservable.add(function () {
        smFullScreenButtonLight.isVisible = true;
    });

    smFullscreenButton.onPointerOutObservable.add(function () {
        smFullScreenButtonLight.isVisible = false;
    });

    let terrainButton = advancedTexture.getControlByName("ButtonTerrain");
    terrainButton.onPointerUpObservable.add(function () { alert("ButtonTerrain Pressed!...."); });
    terrainButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateTerrainButton").isVisible = true });
    terrainButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateTerrainButton").isVisible = false });

    let physicsButton = advancedTexture.getControlByName("ButtonPhysics");
    physicsButton.onPointerUpObservable.add(function () { alert("Physics Button Pressed!...."); });
    physicsButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminatePhysicsButton").isVisible = true });
    physicsButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminatePhysicsButton").isVisible = false });

    let buildingsButton = advancedTexture.getControlByName("ButtonBuildings");
    buildingsButton.onPointerUpObservable.add(function () { alert("ButtonBuildings Pressed!...."); });
    buildingsButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateBuildingsButton").isVisible = true });
    buildingsButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateBuildingsButton").isVisible = false });

    let vegetationButton = advancedTexture.getControlByName("ButtonVegetation");
    vegetationButton.onPointerUpObservable.add(function () { alert("ButtonVegetation Pressed!...."); });
    vegetationButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateVegetationButton").isVisible = true });
    vegetationButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateVegetationButton").isVisible = false });

    let charactersButton = advancedTexture.getControlByName("ButtonCharacters");
    charactersButton.onPointerUpObservable.add(function () { alert("ButtonCharacters Pressed!...."); });
    charactersButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateCharactersButton").isVisible = true });
    charactersButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateCharactersButton").isVisible = false });

    let logicButton = advancedTexture.getControlByName("ButtonLogic");
    logicButton.onPointerUpObservable.add(function () { alert("ButtonLogic Pressed!...."); });
    logicButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateLogicButton").isVisible = true });
    logicButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateLogicButton").isVisible = false });

    let audioButton = advancedTexture.getControlByName("ButtonAudio");
    audioButton.onPointerUpObservable.add(function () { alert("ButtonAudio Pressed!...."); });
    audioButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateAudioButton").isVisible = true });
    audioButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateAudioButton").isVisible = false });

    let hudButton = advancedTexture.getControlByName("ButtonHUD");
    hudButton.onPointerUpObservable.add(function () { alert("ButtonHUD Pressed!...."); });
    hudButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateHUDButton").isVisible = true });
    hudButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateHUDButton").isVisible = false });

    let createButton = advancedTexture.getControlByName("createButton");
    let createButtonLight = advancedTexture.getControlByName("createButtonLight");
    let createPanel = advancedTexture.getControlByName("createPanel");
    
    // Setup small reset button in sync with the main Create Panel
    let sm_resetButton = advancedTexture.getControlByName("sm_resetButton");
    let sm_resetButtonLight = advancedTexture.getControlByName("sm_resetButtonLight");
    let sm_resetCloseIcon = advancedTexture.getControlByName("Image_Close");
    let sm_resetOpenIcon = advancedTexture.getControlByName("Image_Open");

    let toggleCreatePanel = true;    
        
    createButtonLight.isVisible = createPanel.isVisible;   

    createButton.onPointerUpObservable.add(function () {
        if (!createPanel.isVisible) {
            createPanel.isVisible = true;
            toggleCreatePanel = true;
            createButtonLight.isVisible = true;
            sm_resetCloseIcon.isVisible = true;
            sm_resetOpenIcon.isVisible = false;
            sm_resetButtonLight.isVisible = true;
        }
        else {
            createPanel.isVisible = false;
            toggleCreatePanel = false;
            createButtonLight.isVisible = false;
            sm_resetCloseIcon.isVisible = false;
            sm_resetOpenIcon.isVisible = true;
            sm_resetButtonLight.isVisible = false;
        }
    });

    createButton.onPointerEnterObservable.add(function () {
        if (!createPanel.isVisible.isVisible) {
            createButtonLight.isVisible = true;
        }
    });

    createButton.onPointerOutObservable.add(function () {
        if (!createPanel.isVisible) {
            createButtonLight.isVisible = false;
        }
    });

    sm_resetButton.onPointerUpObservable.add(function () {
        if (!toggleCreatePanel) {
            createPanel.isVisible = true;
            toggleCreatePanel = true;
            sm_resetButtonLight.isVisible = true;
            createButtonLight.isVisible = true;
            sm_resetCloseIcon.isVisible = true;
            sm_resetOpenIcon.isVisible = false;
        }
        else {
            createPanel.isVisible = false;
            toggleCreatePanel = false;
            sm_resetButtonLight.isVisible = false;
            createButtonLight.isVisible = false;
            sm_resetCloseIcon.isVisible = false;
            sm_resetOpenIcon.isVisible = true;
        }
    });

    sm_resetButton.onPointerEnterObservable.add(function () {
        sm_resetButtonLight.isVisible = true;
    });

    sm_resetButton.onPointerOutObservable.add(function () {
        sm_resetButtonLight.isVisible = false;
    });


    let assetsButton = advancedTexture.getControlByName("assetsButton");
    let assetsButtonLight = advancedTexture.getControlByName("assetsButtonLight");
    let assetsPanel = advancedTexture.getControlByName("assetsPanel");
    let tabContainer = advancedTexture.getControlByName("Tab Container");
    
    assetsPanel.isVisible = true;
    tabContainer.isVisible = true;

    assetsButtonLight.isVisible = assetsPanel.isVisible;
    assetsButton.onPointerUpObservable.add(function () {
        if (!assetsPanel.isVisible) {
            assetsPanel.isVisible = true;
            tabContainer.isVisible = true;
        }
        else {
            assetsPanel.isVisible = false;
            tabContainer.isVisible = false;
            assetsButtonLight.isVisible = false;
        }
    });

    assetsButton.onPointerEnterObservable.add(function () {
        if (!assetsPanel.isVisible) {
            assetsButtonLight.isVisible = true;
        }
    });

    assetsButton.onPointerOutObservable.add(function () {
        if (!assetsPanel.isVisible) {
            assetsButtonLight.isVisible = false;
        }
    });

    let multiplayerButton = advancedTexture.getControlByName("ButtonMultiplayer");
    multiplayerButton.onPointerUpObservable.add(function () { alert("ButtonMultiplayer Pressed!...."); });
    multiplayerButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateMultiplayerButton").isVisible = true });
    multiplayerButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateMultiplayerButton").isVisible = false });

    let settingsButton = advancedTexture.getControlByName("ButtonSettings");
    settingsButton.onPointerUpObservable.add(function () { alert("ButtonSettings Pressed!...."); });
    settingsButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateSettingsButton").isVisible = true });
    settingsButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateSettingsButton").isVisible = false });

    let playButton = advancedTexture.getControlByName("ButtonPlay");
    playButton.onPointerUpObservable.add(function () { alert("ButtonPlay Pressed!...."); });
    playButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminatePlayButton").isVisible = true });
    playButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminatePlayButton").isVisible = false });

    let helpButton = advancedTexture.getControlByName("ButtonHelp");
    helpButton.onPointerUpObservable.add(function () { alert("ButtonHelp Pressed!...."); });
    helpButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateHelpButton").isVisible = true });
    helpButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateHelpButton").isVisible = false });

    let aboutButton = advancedTexture.getControlByName("ButtonAbout");
    aboutButton.onPointerUpObservable.add(function () { alert("ButtonAbout Pressed!...."); });
    aboutButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateAboutButton").isVisible = true });
    aboutButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateAboutButton").isVisible = false });

    let donateButton = advancedTexture.getControlByName("ButtonDonate");
    donateButton.onPointerUpObservable.add(function () { alert("ButtonDonate Pressed!...."); });
    donateButton.onPointerEnterObservable.add(function () { advancedTexture.getControlByName("illuminateDonateButton").isVisible = true });
    donateButton.onPointerOutObservable.add(function () { advancedTexture.getControlByName("illuminateDonateButton").isVisible = false });

    // Get FPS and other stats
    var textblockFPS = advancedTexture.getControlByName("TextblockFPS");
    var textblockDrawCalls = advancedTexture.getControlByName("TextblockDrawCalls");
    var textblockFaces = advancedTexture.getControlByName("TextblockFaces");
    var textblockVerts = advancedTexture.getControlByName("TextblockVerts");
    var textblockMeshes = advancedTexture.getControlByName("TextblockMeshes");
        
    scene.registerAfterRender(() => {
        textblockFPS.text = " " + Math.round(scene.getEngine().getFps());        
        textblockDrawCalls.text = instrumentation.drawCallsCounter.current;
        textblockFaces.text =  scene.getActiveIndices() / 3;
        textblockVerts.text =  scene.getTotalVertices();
        textblockMeshes.text = scene.getActiveMeshes().length;
    });
    
    //Hide Loader
    engine.hideLoadingUI();

    //var mapFile = serializedSceneToString(scene);
    //console.log("Scene File: \n" + mapFile);
    
    return scene;
};
    

window.initFunction = async function() {                    
                    
    var asyncEngineCreation = async function() {
        try { return createDefaultEngine();} 
        catch(e) {
            console.log("the available createEngine function failed. Creating the default engine instead");
            return createDefaultEngine();
            }
        }

        window.engine = await asyncEngineCreation();
        if (!engine) throw 'engine should not be null.';
        

        startRenderLoop(engine, canvas);
        window.scene = createScene();
    };        
            
        initFunction().then(() => {scene.then(returnedScene => { sceneToRender = returnedScene; });
        
    });
   
        // Resize
        window.addEventListener("resize", function () {
            engine.resize();
        });
        </script>
    </body>
</html>
